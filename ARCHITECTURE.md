# 🏗️ Архитектура и схема работы

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     TELEGRAM USERS                           │
│  (в личном чате или в группе с ботом)                      │
└──────────────────────┬──────────────────────────────────────┘
                       │ Отправляет сообщение/голос
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                  TELEGRAM SERVER                             │
│        (хранит сообщения и файлы пользователя)            │
└──────────────────────┬──────────────────────────────────────┘
                       │ Передает событие через API
                       ↓
┌─────────────────────────────────────────────────────────────┐
│              ВАШЕ ПРИЛОЖЕНИЕ (bot.py)                       │
│                                                             │
│  ┌───────────────────────────────────────────────────┐     │
│  │ Dispatcher (получает все сообщения)               │     │
│  └─────────────────┬─────────────────────────────────┘     │
│                    │                                        │
│  ┌─────────────────┼─────────────────────────────────┐     │
│  │                 │                                  │     │
│  ↓ (если voice)    ↓ (если audio)    ↓ (если text)  │     │
│ handle_voice   handle_audio      handle_message     │     │
│  │                 │                  │               │     │
│  └─────────────────┼──────────────────┼───────────────┘    │
│                    ↓                                        │
│  ┌───────────────────────────────────────────────────┐     │
│  │ Обработка файла:                                 │     │
│  │ 1. Скачать OGG/MP3 → WAV                         │     │
│  │ 2. Отправить в Google Speech Recognition API     │     │
│  │ 3. Получить текст на русском                     │     │
│  │ 4. Транслитерировать в латинские буквы           │     │
│  └───────────────────────────────────────────────────┘     │
│                    ↓                                        │
│  ┌───────────────────────────────────────────────────┐     │
│  │ Отправить результат пользователю                 │     │
│  └───────────────────────────────────────────────────┘     │
└─────────────────────┬──────────────────────────────────────┘
                       │ Отправляет ответ через API
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                  TELEGRAM SERVER                             │
└──────────────────────┬──────────────────────────────────────┘
                       │ Доставляет сообщение
                       ↓
┌─────────────────────────────────────────────────────────────┐
│              ПОЛЬЗОВАТЕЛЬ ПОЛУЧАЕТ ОТВЕТ                    │
│         "🎤 Голосовое сообщение распознано:"               │
│         "Оригинал: Привет как дела"                        │
│         "Транслит: Privet kak dela"                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных для голосового сообщения

```
ШАГИ:

1️⃣ ПОЛУЧЕНИЕ
   Пользователь → Telegram API → Ваш бот
   (файл в формате OGG)

2️⃣ ЗАГРУЗКА
   Telegram API → Локальная папка /tmp
   
3️⃣ КОНВЕРТАЦИЯ
   OGG файл → [pydub] → WAV файл
   (ffmpeg делает тяжелую работу)

4️⃣ РАСПОЗНАВАНИЕ
   WAV файл → [Google Speech Recognition API] → Текст на русском
   Требует интернет!

5️⃣ ТРАНСЛИТЕРАЦИЯ
   "Привет" → [функция transliterate] → "Privet"
   Работает локально, без интернета

6️⃣ ФОРМАТИРОВАНИЕ
   Текст → HTML формат → Красивое сообщение

7️⃣ ОТПРАВКА
   Ваш бот → Telegram API → Пользователь
   (в виде обычного текстового сообщения)

8️⃣ УДАЛЕНИЕ
   Локальные файлы → Удаляются из памяти
```

## 🧬 Структура кода

```
bot.py
├── ИМПОРТЫ
│   ├── asyncio - асинхронность
│   ├── aiogram - работа с Telegram API
│   ├── speech_recognition - распознавание речи
│   ├── pydub - преобразование аудио
│   └── ...
│
├── КОНФИГУРАЦИЯ
│   ├── TOKEN - ваш уникальный ключ бота
│   ├── MAX_VIDEO_SIZE - лимит размера видео
│   └── TRANSLIT_DICT - таблица приведения символов
│
├── ФУНКЦИИ
│   ├── transliterate() - русский → латинский
│   └── (вспомогательные функции)
│
├── ИНИЦИАЛИЗАЦИЯ
│   ├── bot = Bot(...) - объект бота
│   ├── dp = Dispatcher() - диспетчер событий
│   └── welcome_text - приветственное сообщение
│
├── ОБРАБОТЧИКИ (@dp.message())
│   ├── cmd_start() - команда /start
│   ├── handle_voice() - голосовые сообщения
│   ├── handle_audio() - аудиофайлы
│   └── handle_message() - ссылки на медиа
│
├── ГЛАВНАЯ ФУНКЦИЯ
│   └── main() - точка входа программы
│
└── ТОЧКА ВХОДА
    └── if __name__ == "__main__": asyncio.run(main())
```

## 🔐 Безопасность данных

```
Пользователь            Ваш бот              Внешние сервисы
    │                     │                        │
    │──голос──────────→   │                        │
    │                     │──OGG→WAV→──────────→   │
    │                     │         Google API     │
    │                     │←────TEXT(русский)──────│
    │                     │
    │                     │ (Транслитерация)
    │                     │ (Локально, без интернета)
    │                     │
    │←──Text Result──────│
    │                     │
    
ВАЖНО:
✅ Голосовые файлы НЕ хранятся (удаляются после обработки)
✅ Текст отправляется в Google API (для распознавания)
✅ Можно использовать VPN если Google недоступен
✅ Токен бота должен быть в секрете!
```

## 📈 Масштабируемость

### Текущая архитектура (одиночный бот)
```
┌──────────┐
│ 1 Telegram API
│ 1 Python Process
│ 1 Google Speech API
└──────────┘
Может обслужить: ~50 одновременных пользователей
```

### Масштабированная архитектура (для большого трафика)
```
┌────────────────────────────────────────────┐
│        Load Balancer (nginx)               │
└──────────────────┬─────────────────────────┘
                   │
      ┌────────────┼────────────┐
      ↓            ↓            ↓
   Bot #1       Bot #2       Bot #3
   (Worker)     (Worker)     (Worker)
      │            │            │
      └────────────┼────────────┘
                   │
      ┌────────────┴────────────┐
      ↓                         ↓
   Database              Google Speech API
   (Redis/PostgreSQL)
   
Может обслужить: 1000+ одновременных пользователей
```

## ⏱️ Временная диаграмма обработки сообщения

```
Время от начала до конца ответа:

0ms  │ Пользователь отправляет голос
     │
100ms├─ Бот получает файл
     │
200ms├─ Бот скачивает файл (зависит от скорости интернета)
     │
300ms├─ Конвертация OGG → WAV (может быть 0.5-2 сек)
     │
400ms├─ Отправка на Google API
     │
1000ms├─ Google обрабатывает (зависит от длины аудио)
      │
2000ms├─ Получен результат и транслит
      │
2100ms├─ Отправка ответа пользователю
      │
2200ms└─ Пользователь видит результат
      
ИТОГО: 2-5 СЕКУНД
```

## 🔌 Взаимодействие с внешними API

```
┌─────────────────────────────────────────┐
│ Telegram Bot API                        │
│ (https://api.telegram.org/bot...)       │
│                                         │
│ Отправляет/получает сообщения          │
│ Загружает/скачивает файлы              │
│ Управляет пользователями                │
└─────────────────────────────────────────┘
           ↑                    ↑
           │ Использует aiogram │
           │                    │
┌──────────┴────────────────────┴────────┐
│       ВАШ БОТ (bot.py)                 │
└──────────┬────────────────────┬────────┘
           │ Использует         │
           ↓ SpeechRecognition  ↓
┌──────────────────────────────────────┐
│ Google Speech Recognition API        │
│ (https://www.google.com/...)         │
│                                      │
│ Преобразует аудио в текст            │
│ Поддерживает 100+ языков            │
└──────────────────────────────────────┘
```

## 🧪 Тестирование компонентов

```
┌─ Тест 1: Telegram API ────────┐
│ python -c "import aiogram"    │
│ (проверяет что все импорты ок)│
└───────────────────────────────┘

┌─ Тест 2: Google API ─────────────────────┐
│ recognizer.recognize_google(audio_data)  │
│ (проверяет интернет и API доступность)  │
└──────────────────────────────────────────┘

┌─ Тест 3: Транслитерация ───────────────┐
│ transliterate("Привет") == "Privet"    │
│ (проверяет функцию транслитерации)     │
└────────────────────────────────────────┘

┌─ Интеграционный тест ──────────────┐
│ Отправить голос → Получить ответ   │
│ (полный цикл от А до Я)           │
└────────────────────────────────────┘
```

---

**Понимание архитектуры помогает эффективнее разбираться в коде! 🚀**
